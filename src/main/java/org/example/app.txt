package org.example;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class App {

    public static void main(String[] args) {
        System.setProperty("webdriver.chrome.driver", "C:\\drivers\\chromedriver.exe");
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--remote-allow-origins=*");
        WebDriver driver = new ChromeDriver(options);
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(20));

        try {
            // Login to LinkedIn
            driver.get("https://www.linkedin.com/login");
            wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("username"))).sendKeys("jonas.albaira@uoit.net");
            driver.findElement(By.id("password")).sendKeys("jA2892009792#");
            driver.findElement(By.xpath("//button[@type='submit']")).click();
            System.out.println("Logged into LinkedIn!");

            // Navigate to Jobs page and Easy Apply tab (same as your code)...
            wait.until(ExpectedConditions.elementToBeClickable(By.xpath("//a[@href='https://www.linkedin.com/jobs/?']"))).click();
            wait.until(ExpectedConditions.urlToBe("https://www.linkedin.com/jobs/"));
            wait.until(ExpectedConditions.elementToBeClickable(By.xpath("//a[@href='https://www.linkedin.com/jobs/collections/recommended?discover=recommended&discoveryOrigin=JOBS_HOME_JYMBII']"))).click();

            // Click the "Easy Apply" tab
            wait.until(ExpectedConditions.elementToBeClickable(
                            By.xpath("//a[@href='https://www.linkedin.com/jobs/collections/easy-apply?discover=recommended&discoveryOrigin=JOBS_HOME_JYMBII&start=0']")))
                    .click();
            System.out.println("Easy Apply tab clicked!");

            // ‚è±Ô∏è Add a 2-second pause
            try {
                Thread.sleep(2000); // 2000 milliseconds = 2 seconds
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

// ‚úÖ Wait for the scaffold layout to load ‚Äî this ensures Easy Apply tab finished loading
            //wait.until(ExpectedConditions.visibilityOfElementLocated(
            //        By.cssSelector("div.scaffold-layout__list ul li")));
            //System.out.println("Scaffold layout loaded!");

            int currentIndex = 0;

            while (true) {
                try {
                    // üîÅ Re-fetch job listings every time (DOM may change after a click)
                    List<WebElement> jobListings = driver.findElements(By.cssSelector("div.scaffold-layout__list div ul li"));

                    if (currentIndex >= jobListings.size()) {
                        System.out.println("No more job listings.");
                        break;
                    }

                    WebElement job = jobListings.get(currentIndex);

                    // Scroll to element to ensure visibility
                    ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", job);
                    Thread.sleep(1000);  // small wait to avoid click interception

                    job.click();
                    System.out.println("Clicked job listing at index: " + currentIndex);



                    while (true) {
                        try {

                            // ‚úÖ Wait for the job detail panel to load after clicking
                            wait.until(ExpectedConditions.visibilityOfElementLocated(
                                    By.cssSelector("div.jobs-search__job-details--wrapper")));
                            System.out.println("Job details loaded!");

                            try {
                                WebDriverWait shortWait = new WebDriverWait(driver, Duration.ofSeconds(3));
                                WebElement easyApplyButton = shortWait.until(ExpectedConditions.elementToBeClickable(By.id("jobs-apply-button-id")));
                                easyApplyButton.click();
                                System.out.println("Easy Apply button clicked!");
                            } catch (TimeoutException e) {
                                System.out.println("Easy Apply button not found or not clickable within 3 seconds, moving on...");
                                break;

                            }

                            wait.until(ExpectedConditions.visibilityOfElementLocated(By.cssSelector("div.jobs-easy-apply-modal__content")));
                            System.out.println("Easy Apply modal opened!");


                            while (true) {
                                try {
                                    WebElement submitButton = wait.until(ExpectedConditions.elementToBeClickable(
                                            By.xpath("//button[@aria-label='Submit application']")));
                                    submitButton.click();
                                    System.out.println("Submit application clicked!");
                                    // optionally click Done button ...
                                    break; // success, exit loop
                                } catch (TimeoutException e1) {
                                    System.out.println("Submit button not clickable, trying to click Next buttons...");

                                    boolean additionalQuestionsFound = false;

                                    while (!additionalQuestionsFound) {
                                        try {
                                            WebElement nextButton = wait.until(ExpectedConditions.presenceOfElementLocated(
                                                    By.xpath("//*[@aria-label='Continue to next step']")));

                                            // Wait until visible and enabled
                                            wait.until(d -> nextButton.isDisplayed() && nextButton.isEnabled());

                                            // JS click to bypass extra Selenium checks
                                            ((JavascriptExecutor) driver).executeScript("arguments[0].click();", nextButton);
                                            System.out.println("Next button clicked via JS, continuing...");

                                            // Wait for the questions to load
                                            wait.until(ExpectedConditions.visibilityOfElementLocated(
                                                    By.cssSelector("h3.t-16.t-bold")));

                                            additionalQuestionsFound = true;

                                            // process questions...
                                            List<WebElement> legendQuestions = driver.findElements(
                                                    By.xpath("//fieldset/legend//span[@aria-hidden='true']")
                                            );

                                            List<WebElement> labelQuestions2 = driver.findElements(
                                                    By.xpath("//fieldset/label//span[@aria-hidden='true']")
                                            );

                                            List<WebElement> labelQuestions = driver.findElements(
                                                    By.xpath("//label[@class='artdeco-text-input--label']")
                                            );
                                            List<WebElement> generalLabelQuestions = driver.findElements(
                                                    By.xpath("//label//span[@aria-hidden='true']")
                                            );
                                            // Print questions for debug
                                            for (WebElement q : legendQuestions) {
                                                String text = q.getText().trim();
                                                if (!text.isEmpty()) {
                                                    System.out.println("Legend Question: " + text);
                                                }
                                            }
                                            for (WebElement q : labelQuestions2) {
                                                String text = q.getText().trim();
                                                if (!text.isEmpty()) {
                                                    System.out.println("Label Question 2: " + text);
                                                }
                                            }
                                            for (WebElement q : labelQuestions) {
                                                String text = q.getText().trim();
                                                if (!text.isEmpty()) {
                                                    System.out.println("Label Question: " + text);
                                                }
                                            }

                                            for (WebElement q : generalLabelQuestions) {
                                                String text = q.getText().trim();
                                                if (!text.isEmpty()) {
                                                    System.out.println("General Label Question: " + text);
                                                }
                                            }



                                            // Collect all questions into one list
                                            List<String> allQuestions = new ArrayList<>();

                                            allQuestions.addAll(generalLabelQuestions.stream()
                                                    .map(WebElement::getText)
                                                    .map(String::trim)
                                                    .filter(s -> !s.isEmpty())
                                                    .collect(Collectors.toList()));

                                            allQuestions.addAll(legendQuestions.stream()
                                                    .map(WebElement::getText)
                                                    .map(String::trim)
                                                    .filter(s -> !s.isEmpty())
                                                    .collect(Collectors.toList()));

                                            allQuestions.addAll(labelQuestions.stream()
                                                    .map(WebElement::getText)
                                                    .map(String::trim)
                                                    .filter(s -> !s.isEmpty())
                                                    .collect(Collectors.toList()));

                                            // Your resume text (simplified example)
                                            String resumeText = "Jonas Albaira\n" +
                                                    "Software Engineer/Developer\n" +
                                                    "jonas.albaira@gmail.com\n" +
                                                    " \n" +
                                                    "9052425137\n" +
                                                    " \n" +
                                                    "Ontario\n" +
                                                    " \n" +
                                                    "leusdigital.com\n" +
                                                    " \n" +
                                                    "in/jonas-albaira\n" +
                                                    " \n" +
                                                    "SUMMARY\n" +
                                                    "Experienced Software Engineer/Developer with 9+ years of expertise in website and application development. Proficient in React and other JavaScript libraries with Java, Python and PHP backend programming. Strong eye for frontend detailed design and skilled in backend programming\n" +
                                                    "\n" +
                                                    "SKILLS\n" +
                                                    "Front-end ‚Äî HTML, CSS, Javascript, React, CI/CD ‚Äî Jenkins, GitHub, Back-end ‚Äî Python, Java, Lua, PHP, SpringBoot, Cloud Computing ‚Äî AWS, DigitalOcean, GCP, Database ‚Äî SQL, MySQL, Firestore\n" +
                                                    "EXPERIENCE\n" +
                                                    "Code Instructor / Code Sensei\n" +
                                                    "\n" +
                                                    "Code Ninjas\n" +
                                                    "Feb 2024 ‚Äì Present\n" +
                                                    "‚Ä¢Assisted students in developing game building projects using MakeCode Arcade (Javascript Game Framework)\n" +
                                                    "‚Ä¢Taught Python programming classes to students using LEGO robotics kits, combining coding fundamentals with hands-on engineering challenges to enhance learning engagement.\n" +
                                                    "‚Ä¢Built a portfolio of 2D games using Javascript, showcasing skills like sprite animation, collisions, tilemaps, and event-driven logic.\n" +
                                                    "‚Ä¢Created a web-based dashboard with Python backend, React frontend, and Firebase database to track and display student star counts, streamlining progress tracking for Code Ninjas instructors.\n" +
                                                    "Founder/ CTO\n" +
                                                    "\n" +
                                                    "Leus Digital (leusdigital.com)\n" +
                                                    "May 2021 ‚Äì Jan 2024\n" +
                                                    "‚Ä¢Built and scaled a web development business, generating over $10,000 in revenue within the first 3 years.\n" +
                                                    "‚Ä¢Successfully built and scaled 10+ different business websites, including e-commerce websites, landing pages and booking websites.\n" +
                                                    "Software Developer (Java)\n" +
                                                    "\n" +
                                                    "Tata Consultancy Services\n" +
                                                    "Jan 2020 ‚Äì May 2021\n" +
                                                    "‚Ä¢Deployed a Wire Room application for a leading financial institution (Capital Markets and Inventory & Treasury Services).\n" +
                                                    "‚Ä¢Deployed corporate apps, managed Ubuntu servers and IBM WebSphere setups, handled Oracle SQL database tasks.\n" +
                                                    "‚Ä¢Built an internal tool to automate injecting message payloads to MQ's reducing manual efforts by 50%.\n" +
                                                    "‚Ä¢Automated GUI testing with Java Selenium reducing manual efforts by 55%.\n" +
                                                    "‚Ä¢Scripted ISO 20022 data for QA testing, cutting prep time by 80%.\n" +
                                                    "‚Ä¢Assisted AML team with Fircosoft and compliance integration, and managed CI/CD with Jenkins and GitHub for DevOps.\n" +
                                                    "Web Developer\n" +
                                                    "\n" +
                                                    "OntarioTech Student Union\n" +
                                                    "Sep 2018 ‚Äì Jan 2020\n" +
                                                    "‚Ä¢Created a custom WordPress website with responsive design using HTML, CSS, PHP, MySQL, jQuery and JavaScript.\n" +
                                                    "‚Ä¢Enhanced website performance and security, converted PSD to WordPress, and optimized code/database.\n" +
                                                    "‚Ä¢Handled website updates and provided WordPress technical support.\n" +
                                                    "Web Developer\n" +
                                                    "\n" +
                                                    "Medicstox\n" +
                                                    "Sep 2015 ‚Äì Dec 2019\n" +
                                                    "‚Ä¢Developed and scaled an e-commerce site with WooCommerce, WordPress, and custom PHP, MySQL\n" +
                                                    "‚Ä¢Implemented front-end pages and it's components that adheres to best UI/UX practices, increasing sales by 300%\n" +
                                                    "‚Ä¢Optimized the Linux server, NGINX web server and MySQL database to house 10,000 products\n" +
                                                    "EDUCATION\n" +
                                                    "Bachelor of Engineering (Honours) Software Engineering\n" +
                                                    "\n" +
                                                    "OntarioTech University\n" +
                                                    "2019\n" +
                                                    " | \n" +
                                                    "Oshawa, Ontario\n" +
                                                    "CONTRACT HIRES\n" +
                                                    "Tilaus and Kamena Yoga\n" +
                                                    "\n" +
                                                    "(for Strat King Marketing)\n" +
                                                    "Jan 2025 ‚Äì present\n" +
                                                    "Designed and developed fully responsive WordPress websites for Tilaus.io and Kamena Yoga, creating custom layouts, selecting typography and color schemes, and implementing SEO and performance optimizations to deliver a polished, high-impact online presence.\n" +
                                                    "\n" +
                                                    "ReadyMode and Clear Pathways\n" +
                                                    "\n" +
                                                    "(for Brand Vision Marketing)\n" +
                                                    "Jan 2024 ‚Äì May 2024\n" +
                                                    "Built and deployed a responsive WordPress site for Readymode and Clear Pathways, improving site speed, SEO readiness, and user accessibility in alignment with provided visual assets and branding guidelines.\n" +
                                                    "\n" +
                                                    "Ocean Park Mechanical\n" +
                                                    "\n" +
                                                    "(for Brand Vision Marketing)\n" +
                                                    "Jan 2024 ‚Äì May 2024\n" +
                                                    "Integrated a third-party API into OceanPM‚Äôs Webflow website using JavaScript, dynamically fetching and displaying data to enhance site interactivity and content automation.";

                                            // Call ChatGPT API with resume + questions
                                            String chatGptAnswer = callChatGPTApi(resumeText, allQuestions);
                                            System.out.println("\nChatGPT Answers:\n" + chatGptAnswer);



                                        } catch (TimeoutException e) {
                                            System.out.println("Next button not found or Additional Questions not yet visible.");

                                        }
                                    }

                                }
                            }
                            break; // success break out of outer loop
                           } catch (Exception e) {
                        System.out.println("Failed to click job listing: " + e.getMessage());
                    }

                    currentIndex++; // move to the next job regardless
                }

                    break; // break if Easy Apply succeeds

                } catch (TimeoutException e) {
                    System.out.println("Easy Apply button not available. Clicking on next job listing...");

                } catch (Exception e2) {
                    System.out.println("Failed to click job listing: " + e2.getMessage());
                    break;
                }
            }
            // Loop for Easy Apply


        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            driver.quit();
        }
    }

    public static String callChatGPTApi(String resume, List<String> questions) throws Exception {
        String apiKey = System.getenv("OPENAI_API_KEY");
        if (apiKey == null) {
            throw new RuntimeException("OPENAI_API_KEY environment variable not set.");
        }

        // Build prompt
        StringBuilder promptBuilder = new StringBuilder();
        promptBuilder.append("You are a job applicant assistant. Based on the resume below, answer these application questions truthfully and concisely.\n\n");
        promptBuilder.append("Resume:\n").append(resume).append("\n\n");
        promptBuilder.append("Questions:\n");
        for (String q : questions) {
            promptBuilder.append("- ").append(q).append("\n");
        }
        promptBuilder.append("\nAnswers:\n");

        String prompt = promptBuilder.toString();

        // Escape JSON special characters
        String escapedPrompt = prompt.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", "\\n");

        String jsonPayload = String.format(
                "{ \"model\": \"gpt-4o-mini\", \"messages\": [{\"role\":\"user\",\"content\": \"%s\"}], \"temperature\": 0.3 }",
                escapedPrompt
        );

        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create("https://api.openai.com/v1/chat/completions"))
                .timeout(Duration.ofSeconds(30))
                .header("Content-Type", "application/json")
                .header("Authorization", "Bearer " + apiKey)
                .POST(HttpRequest.BodyPublishers.ofString(jsonPayload))
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        if (response.statusCode() != 200) {
            throw new RuntimeException("Failed to call OpenAI API: " + response.body());
        }

        JsonObject jsonResponse = JsonParser.parseString(response.body()).getAsJsonObject();
        String answer = jsonResponse
                .getAsJsonArray("choices")
                .get(0)
                .getAsJsonObject()
                .get("message")
                .getAsJsonObject()
                .get("content")
                .getAsString();

        return answer.trim();
    }
}
