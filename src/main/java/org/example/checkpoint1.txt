package org.example;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class App {

    public static void main(String[] args) {
        System.setProperty("webdriver.chrome.driver", "C:\\drivers\\chromedriver.exe");
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--remote-allow-origins=*");
        WebDriver driver = new ChromeDriver(options);
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(8));

        // Step 1
        try {
            // 1. Go to LinkedIn login page
            driver.get("https://www.linkedin.com/login");

            // 2. Enter username
            WebElement username = driver.findElement(By.id("username"));
            username.sendKeys("jonas.albaira@uoit.net");

            // 3. Enter password
            WebElement password = driver.findElement(By.id("password"));
            password.sendKeys("jA2892009792#");

            // 4. Click submit button
            WebElement submitButton = driver.findElement(By.xpath("//button[@type='submit']"));
            submitButton.click();

            wait.until(ExpectedConditions.urlContains("feed"));
            // OR wait for some known homepage element:
            // wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("global-nav-search")));

            System.out.println("Step 1 successful.");

        } catch (Exception e) {
            System.out.println("Login failed: " + e.getMessage());
            driver.quit();
            return; // Stop execution if login fails
        }

        //Step 2
        try {
            // Try block: Navigate to Jobs page
            WebElement jobsButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[@href='https://www.linkedin.com/jobs/?']")));
            jobsButton.click();

            wait.until(ExpectedConditions.urlToBe("https://www.linkedin.com/jobs/"));

            WebElement showAllButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[@href='https://www.linkedin.com/jobs/collections/recommended?discover=recommended&discoveryOrigin=JOBS_HOME_JYMBII']")));
            showAllButton.click();

            System.out.println("Navigated to Jobs List Page.");

            wait.until(ExpectedConditions.urlContains("jobs"));
            // OR wait for some known homepage element:
            // wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("global-nav-search")));

            System.out.println("Step 2 successful.");
        } catch (Exception e) {
            System.out.println("Navigation to Jobs failed: " + e.getMessage());
        }

        try {
            // Click the Easy Apply tab
            WebElement easyApplyTab = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[contains(@href, '/jobs/collections/easy-apply')]")));
            easyApplyTab.click();

            System.out.println("Clicked on Easy Apply tab.");
            wait.until(ExpectedConditions.urlContains("easy"));
        } catch (Exception e) {
            System.out.println("Clicking Easy Apply tab failed: " + e.getMessage());
        }

        try {
            List<WebElement> jobList = driver.findElements(By.cssSelector("div.scaffold-layout__list ul li"));

            for (int i = 0; i < jobList.size(); i++) {
                final int index = i;
                try {
                    // Scroll to the job item
                    WebElement jobItem = driver.findElements(By.cssSelector("div.scaffold-layout__list ul li")).get(index);
                    ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView({block: 'center'});", jobItem);
                    Thread.sleep(500);

                    // Wait for the clickable anchor
                    WebElement anchor = wait.until(driver1 ->
                            driver1.findElements(By.cssSelector("a.job-card-container__link")).get(index)
                    );

                    // Click the job listing
                    ((JavascriptExecutor) driver).executeScript("arguments[0].click();", anchor);
                    System.out.println("Clicked job listing #" + (index + 1));
                    Thread.sleep(3000); // Allow time for job details to load

                    // ðŸ‘‰ Call your custom method to fill out the form
                    fillOutForm(driver);

                } catch (Exception e) {
                    System.out.println("Error clicking job #" + (index + 1) + ": " + e.getMessage());
                }
            }

        } catch (Exception e) {
            System.out.println("Failed to grab or click job listings: " + e.getMessage());
        }

    }
    private static void fillOutForm(WebDriver driver) {
        try {
            // Example: Wait for "Easy Apply" button and click
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));
            WebElement easyApplyButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.cssSelector("button.jobs-apply-button")));

            easyApplyButton.click();
            System.out.println("Opened Easy Apply form.");

            // ... add logic to fill in fields, upload resume, click next/submit, etc.
            Thread.sleep(30000); // simulate wait during form interaction

        } catch (Exception e) {
            System.out.println("Failed to fill out form: " + e.getMessage());
        }
    }

    public static String callChatGPTApi(String resume, List<String> questions) throws Exception {
        String apiKey = System.getenv("OPENAI_API_KEY");
        if (apiKey == null) {
            throw new RuntimeException("OPENAI_API_KEY environment variable not set.");
        }

        // Build prompt
        StringBuilder promptBuilder = new StringBuilder();
        promptBuilder.append("You are a job applicant assistant. Based on the resume below, answer these application questions truthfully and concisely.\n\n");
        promptBuilder.append("Resume:\n").append(resume).append("\n\n");
        promptBuilder.append("Questions:\n");
        for (String q : questions) {
            promptBuilder.append("- ").append(q).append("\n");
        }
        promptBuilder.append("\nAnswers:\n");

        String prompt = promptBuilder.toString();

        // Escape JSON special characters
        String escapedPrompt = prompt.replace("\\", "\\\\").replace("\"", "\\\"").replace("\n", "\\n");

        String jsonPayload = String.format(
                "{ \"model\": \"gpt-4o-mini\", \"messages\": [{\"role\":\"user\",\"content\": \"%s\"}], \"temperature\": 0.3 }",
                escapedPrompt
        );

        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create("https://api.openai.com/v1/chat/completions"))
                .timeout(Duration.ofSeconds(30))
                .header("Content-Type", "application/json")
                .header("Authorization", "Bearer " + apiKey)
                .POST(HttpRequest.BodyPublishers.ofString(jsonPayload))
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        if (response.statusCode() != 200) {
            throw new RuntimeException("Failed to call OpenAI API: " + response.body());
        }

        JsonObject jsonResponse = JsonParser.parseString(response.body()).getAsJsonObject();
        String answer = jsonResponse
                .getAsJsonArray("choices")
                .get(0)
                .getAsJsonObject()
                .get("message")
                .getAsJsonObject()
                .get("content")
                .getAsString();

        return answer.trim();
    }
}
