package org.example;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class App {

    public static void main(String[] args) {
        System.setProperty("webdriver.chrome.driver", "C:\\drivers\\chromedriver.exe");
        ChromeOptions options = new ChromeOptions();
        options.addArguments("--remote-allow-origins=*");
        WebDriver driver = new ChromeDriver(options);
        WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(8));

        // Step 1
        try {
            // 1. Go to LinkedIn login page
            driver.get("https://www.linkedin.com/login");

            // 2. Enter username
            WebElement username = driver.findElement(By.id("username"));
            username.sendKeys("jonas.albaira@uoit.net");

            // 3. Enter password
            WebElement password = driver.findElement(By.id("password"));
            password.sendKeys("jA2892009792#");

            // 4. Click submit button
            WebElement submitButton = driver.findElement(By.xpath("//button[@type='submit']"));
            submitButton.click();

            wait.until(ExpectedConditions.urlContains("feed"));
            // OR wait for some known homepage element:
            // wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("global-nav-search")));

            System.out.println("Step 1 successful.");

        } catch (Exception e) {
            System.out.println("Login failed: " + e.getMessage());
            driver.quit();
            return; // Stop execution if login fails
        }

        //Step 2
        try {
            // Try block: Navigate to Jobs page
            WebElement jobsButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[@href='https://www.linkedin.com/jobs/?']")));
            jobsButton.click();

            wait.until(ExpectedConditions.urlToBe("https://www.linkedin.com/jobs/"));

            WebElement showAllButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[@href='https://www.linkedin.com/jobs/collections/recommended?discover=recommended&discoveryOrigin=JOBS_HOME_JYMBII']")));
            showAllButton.click();

            System.out.println("Navigated to Jobs List Page.");

            wait.until(ExpectedConditions.urlContains("jobs"));
            // OR wait for some known homepage element:
            // wait.until(ExpectedConditions.visibilityOfElementLocated(By.id("global-nav-search")));

            System.out.println("Step 2 successful.");
        } catch (Exception e) {
            System.out.println("Navigation to Jobs failed: " + e.getMessage());
        }

        try {
            // Click the Easy Apply tab
            WebElement easyApplyTab = wait.until(ExpectedConditions.elementToBeClickable(
                    By.xpath("//a[contains(@href, '/jobs/collections/easy-apply')]")));
            easyApplyTab.click();

            System.out.println("Clicked on Easy Apply tab.");
            wait.until(ExpectedConditions.urlContains("easy"));
        } catch (Exception e) {
            System.out.println("Clicking Easy Apply tab failed: " + e.getMessage());
        }

        try {
            List<WebElement> jobList = driver.findElements(By.cssSelector("div.scaffold-layout__list ul li"));

            for (int i = 0; i < jobList.size(); i++) {
                final int index = i;
                try {
                    List<WebElement> jobItems = driver.findElements(By.cssSelector("div.scaffold-layout__list ul li"));
                    if (index >= jobItems.size()) {
                        System.out.println("Index out of bounds: " + index);
                        return;
                    }

                    WebElement jobItem = jobItems.get(index);

                    // Scroll the job item into view
                    ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView({block: 'center'});", jobItem);
                    Thread.sleep(500);

                    // Find anchor relative to the job item
                    WebElement anchor = jobItem.findElement(By.cssSelector("a.job-card-container__link"));

                    // Wait until the anchor is clickable
                    wait.until(ExpectedConditions.elementToBeClickable(anchor));

                    // Click using JavaScript to avoid intercept issues
                    ((JavascriptExecutor) driver).executeScript("arguments[0].click();", anchor);
                    System.out.println("Clicked job listing #" + (index + 1));
                    Thread.sleep(2000); // Give time for job details to load

                    // Fill out form
                    fillOutForm(driver);
                    Thread.sleep(8000); // Allow time for the form submission

                } catch (Exception e) {
                    System.out.println("Error clicking job #" + (index + 1) + ": " + e.getMessage());
                }

            }

        } catch (Exception e) {
            System.out.println("Failed to grab or click job listings: " + e.getMessage());
        }

    }
    private static void fillOutForm(WebDriver driver) {
        try {
            Thread.sleep(2500); // Wait for 2.5 seconds

            WebElement easyApplyButton = driver.findElement(By.cssSelector("button.jobs-apply-button"));

            if (easyApplyButton.isDisplayed() && easyApplyButton.isEnabled()) {
                easyApplyButton.click();
            }
            System.out.println("Opened Easy Apply form.");

            // Wait for the Easy Apply modal to fully load (optional sleep)
            Thread.sleep(2000);

            while (true) {
                // Check if the target h3 element is present
                List<WebElement> h3Elements = driver.findElements(By.xpath("//h3[text()='Additional Questions']"));
                if (!h3Elements.isEmpty()) {
                    System.out.println("Found the 'Additional Questions' header.");
                    break;
                }


                // Try to find and click the Next button
                List<WebElement> nextButtons = driver.findElements(By.xpath("//*[@aria-label='Continue to next step']"));
                if (!nextButtons.isEmpty()) {
                    WebElement nextButton = nextButtons.get(0);
                    if (nextButton.isDisplayed() && nextButton.isEnabled()) {
                        nextButton.click();
                        System.out.println("Clicked Next button.");
                        Thread.sleep(1000); // allow page to update
                    } else {
                        System.out.println("Next button is not clickable.");
                        break;
                    }
                } else {
                    System.out.println("No Next button found. Possibly at last step.");
                    break;
                }
            }

            System.out.println("Here");

            // process questions...
            List<WebElement> legendQuestions = driver.findElements(
                    By.xpath("//fieldset/legend//span[@aria-hidden='true']")
            );

            List<WebElement> labelQuestions2 = driver.findElements(
                    By.xpath("//fieldset/label//span[@aria-hidden='true']")
            );

            List<WebElement> labelQuestions = driver.findElements(
                    By.xpath("//label[@class='artdeco-text-input--label']")
            );
            List<WebElement> generalLabelQuestions = driver.findElements(
                    By.xpath("//label//span[@aria-hidden='true']")
            );
            // Print questions for debug
            for (WebElement q : legendQuestions) {
                String text = q.getText().trim();
                if (!text.isEmpty()) {
                    System.out.println("Legend Question: " + text);
                }
            }
            for (WebElement q : labelQuestions2) {
                String text = q.getText().trim();
                if (!text.isEmpty()) {
                    System.out.println("Label Question 2: " + text);
                }
            }
            for (WebElement q : labelQuestions) {
                String text = q.getText().trim();
                if (!text.isEmpty()) {
                    System.out.println("Label Question: " + text);
                }
            }

            for (WebElement q : generalLabelQuestions) {
                String text = q.getText().trim();
                if (!text.isEmpty()) {
                    System.out.println("General Label Question: " + text);
                }
            }



            // Collect all questions into one list
            List<String> allQuestions = new ArrayList<>();

            allQuestions.addAll(generalLabelQuestions.stream()
                    .map(WebElement::getText)
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .collect(Collectors.toList()));

            /*allQuestions.addAll(legendQuestions.stream()
                    .map(WebElement::getText)
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .collect(Collectors.toList()));*/

            allQuestions.addAll(labelQuestions.stream()
                    .map(WebElement::getText)
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .collect(Collectors.toList()));

            // Your resume text (simplified example)
            String resumeText = "Jonas Albaira\n" +
                    "Software Engineer/Developer\n" +
                    "jonas.albaira@gmail.com\n" +
                    " \n" +
                    "9052425137\n" +
                    " \n" +
                    "Ontario\n" +
                    " \n" +
                    "leusdigital.com\n" +
                    " \n" +
                    "in/jonas-albaira\n" +
                    " \n" +
                    "SUMMARY\n" +
                    "Experienced Software Engineer/Developer with 9+ years of expertise in website and application development. Proficient in React and other JavaScript libraries with Java, Python and PHP backend programming. Strong eye for frontend detailed design and skilled in backend programming\n" +
                    "\n" +
                    "SKILLS\n" +
                    "Front-end ‚Äî HTML, CSS, Javascript, React, CI/CD ‚Äî Jenkins, GitHub, Back-end ‚Äî Python, Java, Lua, PHP, SpringBoot, Cloud Computing ‚Äî AWS, DigitalOcean, GCP, Database ‚Äî SQL, MySQL, Firestore\n" +
                    "EXPERIENCE\n" +
                    "Code Instructor / Code Sensei\n" +
                    "\n" +
                    "Code Ninjas\n" +
                    "Feb 2024 ‚Äì Present\n" +
                    "‚Ä¢Assisted students in developing game building projects using MakeCode Arcade (Javascript Game Framework)\n" +
                    "‚Ä¢Taught Python programming classes to students using LEGO robotics kits, combining coding fundamentals with hands-on engineering challenges to enhance learning engagement.\n" +
                    "‚Ä¢Built a portfolio of 2D games using Javascript, showcasing skills like sprite animation, collisions, tilemaps, and event-driven logic.\n" +
                    "‚Ä¢Created a web-based dashboard with Python backend, React frontend, and Firebase database to track and display student star counts, streamlining progress tracking for Code Ninjas instructors.\n" +
                    "Founder/ CTO\n" +
                    "\n" +
                    "Leus Digital (leusdigital.com)\n" +
                    "May 2021 ‚Äì Jan 2024\n" +
                    "‚Ä¢Built and scaled a web development business, generating over $10,000 in revenue within the first 3 years.\n" +
                    "‚Ä¢Successfully built and scaled 10+ different business websites, including e-commerce websites, landing pages and booking websites.\n" +
                    "Software Developer (Java)\n" +
                    "\n" +
                    "Tata Consultancy Services\n" +
                    "Jan 2020 ‚Äì May 2021\n" +
                    "‚Ä¢Deployed a Wire Room application for a leading financial institution (Capital Markets and Inventory & Treasury Services).\n" +
                    "‚Ä¢Deployed corporate apps, managed Ubuntu servers and IBM WebSphere setups, handled Oracle SQL database tasks.\n" +
                    "‚Ä¢Built an internal tool to automate injecting message payloads to MQ's reducing manual efforts by 50%.\n" +
                    "‚Ä¢Automated GUI testing with Java Selenium reducing manual efforts by 55%.\n" +
                    "‚Ä¢Scripted ISO 20022 data for QA testing, cutting prep time by 80%.\n" +
                    "‚Ä¢Assisted AML team with Fircosoft and compliance integration, and managed CI/CD with Jenkins and GitHub for DevOps.\n" +
                    "Web Developer\n" +
                    "\n" +
                    "OntarioTech Student Union\n" +
                    "Sep 2018 ‚Äì Jan 2020\n" +
                    "‚Ä¢Created a custom WordPress website with responsive design using HTML, CSS, PHP, MySQL, jQuery and JavaScript.\n" +
                    "‚Ä¢Enhanced website performance and security, converted PSD to WordPress, and optimized code/database.\n" +
                    "‚Ä¢Handled website updates and provided WordPress technical support.\n" +
                    "Web Developer\n" +
                    "\n" +
                    "Medicstox\n" +
                    "Sep 2015 ‚Äì Dec 2019\n" +
                    "‚Ä¢Developed and scaled an e-commerce site with WooCommerce, WordPress, and custom PHP, MySQL\n" +
                    "‚Ä¢Implemented front-end pages and it's components that adheres to best UI/UX practices, increasing sales by 300%\n" +
                    "‚Ä¢Optimized the Linux server, NGINX web server and MySQL database to house 10,000 products\n" +
                    "EDUCATION\n" +
                    "Bachelor of Engineering (Honours) Software Engineering\n" +
                    "\n" +
                    "OntarioTech University\n" +
                    "2019\n" +
                    " | \n" +
                    "Oshawa, Ontario\n" +
                    "CONTRACT HIRES\n" +
                    "Tilaus and Kamena Yoga\n" +
                    "\n" +
                    "(for Strat King Marketing)\n" +
                    "Jan 2025 ‚Äì present\n" +
                    "Designed and developed fully responsive WordPress websites for Tilaus.io and Kamena Yoga, creating custom layouts, selecting typography and color schemes, and implementing SEO and performance optimizations to deliver a polished, high-impact online presence.\n" +
                    "\n" +
                    "ReadyMode and Clear Pathways\n" +
                    "\n" +
                    "(for Brand Vision Marketing)\n" +
                    "Jan 2024 ‚Äì May 2024\n" +
                    "Built and deployed a responsive WordPress site for Readymode and Clear Pathways, improving site speed, SEO readiness, and user accessibility in alignment with provided visual assets and branding guidelines.\n" +
                    "\n" +
                    "Ocean Park Mechanical\n" +
                    "\n" +
                    "(for Brand Vision Marketing)\n" +
                    "Jan 2024 ‚Äì May 2024\n" +
                    "Integrated a third-party API into OceanPM‚Äôs Webflow website using JavaScript, dynamically fetching and displaying data to enhance site interactivity and content automation.";

            // Call ChatGPT API with resume + questions
            List<WebElement> labelElements = driver.findElements(
                    By.xpath("//label[contains(@class, 'artdeco-text-input--label') or contains(@class, 'artdeco-text-input--input')]")
            );

            for (WebElement label : labelElements) {
                String question = label.getText().trim();
                if (question.isEmpty()) continue;

                // Call ChatGPT API to generate answer
                String answer = callChatGPTApi(resumeText, question);
                System.out.println("Q: " + question);
                System.out.println("A: " + answer);
                System.out.println("-------------------------");

                // Type answer into corresponding input box
                String inputId = label.getAttribute("for");
                try {
                    WebElement inputField = driver.findElement(By.id(inputId));
                    inputField.clear(); // optional
                    inputField.sendKeys(answer);
                } catch (Exception e) {
                    System.out.println("‚ö†Ô∏è Could not find input for label: " + question);
                    e.printStackTrace();
                }
            }

            List<WebElement> dropdownLabels = driver.findElements(
                    By.xpath("//label[contains(@class, 'fb-dash-form-element__label')]")
            );

            for (WebElement label : dropdownLabels) {
                String question = label.getText().trim();
                if (question.isEmpty()) continue;

                String selectId = label.getAttribute("for");
                if (selectId == null || selectId.isEmpty()) continue;

                try {
                    WebElement selectElement = driver.findElement(By.id(selectId));
                    List<WebElement> options = selectElement.findElements(By.tagName("option"));

                    List<String> optionTexts = new ArrayList<>();
                    for (WebElement option : options) {
                        String text = option.getText().trim();
                        if (!text.isEmpty() && !text.toLowerCase().contains("select")) {
                            optionTexts.add(text);
                        }
                    }

                    // üëá Reuse your current method ‚Äî just craft the question differently
                    String multipleChoiceQuestion = question + "\nOptions: " + String.join(", ", optionTexts)
                            + "\n\nWhich of these options is most appropriate based on the resume?";
                    String bestAnswer = callChatGPTApi(resumeText, multipleChoiceQuestion);

                    System.out.println("Q: " + question);
                    System.out.println("Options: " + optionTexts);
                    System.out.println("A: " + bestAnswer);
                    System.out.println("-------------------------");

                    // Match GPT‚Äôs answer to a dropdown option and select it
                    boolean optionSelected = false;
                    for (WebElement option : options) {
                        if (option.getText().trim().equalsIgnoreCase(bestAnswer.trim())) {
                            option.click();
                            optionSelected = true;
                            break;
                        }
                    }

                    if (!optionSelected) {
                        System.out.println("‚ö†Ô∏è No matching option found for: " + bestAnswer);
                    }

                } catch (Exception e) {
                    System.out.println("‚ö†Ô∏è Could not handle dropdown for label: " + question);
                    e.printStackTrace();
                }
            }

            List<WebElement> fieldsets = driver.findElements(
                    By.xpath("//fieldset[@data-test-form-builder-radio-button-form-component='true']")
            );

            for (WebElement fieldset : fieldsets) {
                try {
                    // Get the question (legend > span with label)
                    WebElement labelSpan = fieldset.findElement(By.cssSelector("legend .fb-dash-form-element__label"));
                    String question = labelSpan.getText().trim();
                    if (question.isEmpty()) continue;

                    // Get all radio option labels
                    List<WebElement> radioLabels = fieldset.findElements(By.cssSelector("label[data-test-text-selectable-option__label]"));
                    List<String> options = new ArrayList<>();
                    for (WebElement label : radioLabels) {
                        String optionText = label.getText().trim();
                        if (!optionText.isEmpty()) {
                            options.add(optionText);
                        }
                    }

                    if (options.isEmpty()) continue;

                    // Construct GPT question prompt
                    String multipleChoiceQuestion = question + "\nOptions: " + String.join(", ", options)
                            + "\n\nWhich of these options is most appropriate based on the resume?";
                    String bestAnswer = callChatGPTApi(resumeText, multipleChoiceQuestion);

                    System.out.println("Q: " + question);
                    System.out.println("Options: " + options);
                    System.out.println("A: " + bestAnswer);
                    System.out.println("-------------------------");

                    // Match and click the correct radio button
                    // Match and click the correct radio button
                    boolean selected = false;
                    for (WebElement label : radioLabels) {
                        if (label.getText().trim().equalsIgnoreCase(bestAnswer.trim())) {
                            label.click(); // ‚úÖ click the label, not the input
                            selected = true;
                            break;
                        }
                    }

                    if (!selected) {
                        System.out.println("‚ö†Ô∏è Could not match or select radio option: " + bestAnswer);
                    }

                } catch (Exception e) {
                    System.out.println("‚ö†Ô∏è Error handling radio fieldset");
                    e.printStackTrace();
                }
            }

            Thread.sleep(2000);

            try {
                // Try to find and click the "Next" button
                WebElement nextButton = driver.findElement(
                        By.xpath("//button[@data-easy-apply-next-button or @data-live-test-easy-apply-next-button]")
                );
                nextButton.click();
                System.out.println("‚úÖ Clicked Next button");
            } catch (NoSuchElementException e1) {
                try {
                    // Fallback: Try to find and click the "Review" button
                    WebElement reviewButton = driver.findElement(
                            By.xpath("//button[@data-live-test-easy-apply-review-button]")
                    );
                    reviewButton.click();
                    System.out.println("‚úÖ Clicked Review button");
                } catch (NoSuchElementException e2) {
                    System.out.println("‚ö†Ô∏è Neither 'Next' nor 'Review' button found.");
                }
            }

            Thread.sleep(2000);

            // Locate the button by its aria-label or visible text
            WebElement submitButton = driver.findElement(By.xpath("//button[@aria-label='Submit application']"));

// Scroll into view if needed
            ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", submitButton);

// Click it
            submitButton.click();

            Thread.sleep(3000);

            WebElement doneButton = driver.findElement(By.xpath("//button[.//span[text()='Done']]"));
            doneButton.click();


        } catch (Exception e) {
            System.out.println("Failed to fill out form: " + e.getMessage());
        }
    }


    public static String callChatGPTApi(String resume, String question) throws Exception {
        String apiKey = System.getenv("OPENAI_API_KEY");
        if (apiKey == null) {
            throw new RuntimeException("OPENAI_API_KEY environment variable not set.");
        }

        String prompt = "You are a job applicant assistant. Based on the resume below, answer this application question truthfully and concisely. If a question asked How many years of experience just return the integer value answer. If asked what percentage or any question asking for a number, just return an integer value. If asked for my location, just return the text Oshawa\n\n"
                + "Resume:\n" + resume + "\n\n"
                + "Question:\n" + question + "\n\n"
                + "Answer:";

        // Escape for JSON
        String escapedPrompt = prompt.replace("\\", "\\\\")
                .replace("\"", "\\\"")
                .replace("\n", "\\n");

        String jsonPayload = String.format(
                "{ \"model\": \"gpt-4o-mini\", \"messages\": [{\"role\":\"user\",\"content\": \"%s\"}], \"temperature\": 0.3 }",
                escapedPrompt
        );

        HttpClient client = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create("https://api.openai.com/v1/chat/completions"))
                .timeout(Duration.ofSeconds(30))
                .header("Content-Type", "application/json")
                .header("Authorization", "Bearer " + apiKey)
                .POST(HttpRequest.BodyPublishers.ofString(jsonPayload))
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        if (response.statusCode() != 200) {
            throw new RuntimeException("Failed to call OpenAI API: " + response.body());
        }

        JsonObject jsonResponse = JsonParser.parseString(response.body()).getAsJsonObject();
        String answer = jsonResponse
                .getAsJsonArray("choices")
                .get(0)
                .getAsJsonObject()
                .get("message")
                .getAsJsonObject()
                .get("content")
                .getAsString();

        return answer.trim();
    }
}
